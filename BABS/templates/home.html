{% extends "base.html" %}

{% block content %}
<style>
  .button-container {
    float: right;
  }
</style>
<div class="content-wrapper">
<!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
    </div>
  </section>

	<!-- Main content -->
	<section class="content">
		<div class="container-fluid">

      <div class="card"><!-- Charts table -->
				<div class="card-header">
					<h5>
						<i class="fas fa-chart-simple"></i>
						&nbsp;Charts
					</h5>
				</div>

				<div class="card-body">
          <div style="width: 800px;">
            <canvas id="chart"></canvas>
          </div>
				</div><!-- card body -->
		  </div><!-- card -->

			<div class="card"><!-- Active Jobs -->
				<div class="card-header">
					<h5>
						<i class="fas fa-list-check"></i>
						&nbsp;Active Tasks
          </h5>
				</div>

				<div class="card-body">
					<table id="active_tasks" class="table table-borderless table-hover">
						<thead>
							<tr>
                <th><i class="fas fa-id-badge"></i>&nbsp;ID</th>
                <th><i class="fas fa-coins"></i>&nbsp;Pair</th>
                <th><i class="fas fa-clock"></i>&nbsp;Next run UTC</th>
                <th><i class="fas fa-rotate-right"></i>&nbsp;Interval</th>
                <th><i class="fas fa-chart-bar"></i>&nbsp;Grouping</th>
                <th><i class="fas fa-calculator"></i>&nbsp;Depth</th>
                <th><i class="fas fa-circle-exclamation"></i>&nbsp;Actions</th>
							</tr>
						</thead>

						{% if tasks %}
						<tbody>
              {% for task in tasks %}
							<tr>
                <td>{{ task.id }}</td>
								<td>{{ task.symbol }}</td>
								<td>{{ task.next_run }}</td>
                <td>{{ task.interval }}<small>&nbsp;mins</small></td>
								<td>{{ task.grouping }}</td>
                <td>{{ task.depth }}</td>
                <td>
                  {% csrf_token %}
                  <button type="button" onclick="deleteRow({{ task.id }})" class="btn btn-danger" data-toggle="tooltip" data-placement="top" title="Delete task">
                    Delete&nbsp;<i class="fas fa-trash"></i>
                  </button>
                </td>
							</tr>
              {% endfor %}
						</tbody>
            {% endif %}	

					</table>
				</div><!-- card body -->
		  </div><!-- card -->

	  </div><!-- container-fluid -->

	</section>
</div><!-- content-wrapper -->


<!-- Active Tasks Datatable -->
<script>
  $(function () {
    let table = $('#active_tasks').DataTable({
      dom: '<"button-container"B>lfrtip',
      responsive: true,
      buttons: [
        {
          extend: 'copy',
          text: '<i class="fas fa-copy"></i> Copy',
          className: 'btn btn-light',
          exportOptions: {
            columns: ':visible'
          }
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print"></i> Print',
          className: 'btn btn-light',
          exportOptions: {
            columns: ':visible'
          }
        },
        {
          extend: 'csv',
          text: '<i class="fas fa-file-csv"></i> CSV',
          className: 'btn btn-light',
          exportOptions: {
            columns: ':visible'
          }
        },
        {
          extend: 'pdf',
          text: '<i class="fas fa-file-pdf"></i> PDF',
          className: 'btn btn-light',
          exportOptions: {
            columns: ':visible'
          }
        }
        ]
    });
  
  });
</script>


<!-- Delete table row function -->
<script>
  function deleteRow(taskId) {
  let result = confirm("Are you sure you want to delete this task?");

  if (result) {
  // Perform delete action
    $.ajax({
      url: "{% url 'deletetasks' %}",
      dataType: "text",
      method: "POST",
      data : {
      csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
      data: JSON.stringify(taskId),
      },
      success: function(data, status, xhr){
        location.reload();
      },
      error: function(xhr, status, error){
      }
    })
  } else {
  // User clicked Cancel or closed the dialog box
  // Do nothing
  }
};
</script>

<!-- ChartJs -->
<script>
  /*

// fetch data from your view
fetch("{% url 'chartview' %}")
  .then(response => response.json())
  .then(data => {
    let asksData = [];
    let bidsData = [];

    // iterate over each record in the data
    data.forEach(record => {
      let time = record['timestamp']; // set your X-axis value here
      let asks = JSON.parse(record['asks']);
      let bids = JSON.parse(record['bids']);

      // calculate the biggest quantity for each asks and bids
      let maxAsk = Math.max(...Object.values(asks).map(o => o.Quantity));
      let maxBid = Math.max(...Object.values(bids).map(o => o.Quantity));

      // add each point to the appropriate dataset
      Object.values(asks).forEach(ask => {
        let point = {
          x: time,
          y: ask['Weighted Price'],
          r: ask['Quantity'] == maxAsk ? 10 : 5 // set the size of the point based on quantity
        }
        asksData.push(point);
      });

      Object.values(bids).forEach(bid => {
        let point = {
          x: time,
          y: bid['Weighted Price'],
          r: bid['Quantity'] == maxBid ? 10 : 5
        }
        bidsData.push(point);
      });
    });
      options: {
        scales: {
          xAxes: [{
            type: 'time',
            time: {
              displayFormats: {
                minute: 'MMM D, h:mm a'
              }
            }
          }],
          yAxes: [{
            type: 'linear',
      
  });
*/
</script>

<script>
  function getData() {
    fetch("{% url 'chartview' %}")
    .then(response => response.json())
    .then(data => {
    let asksData = [];
    let bidsData = [];

    // iterate over each record in the data
    data.forEach(record => {
      let time = record['timestamp']; // set your X-axis value here
      let asks = JSON.parse(record['asks']);
      let bids = JSON.parse(record['bids']);
    }
  })
  console.log(asks)
}
  
  const ctx = document.getElementById('chart');

  new Chart(ctx, {
    type: 'line',
    data: {
    /*
      labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
      datasets: [{
        label: '# of Votes',
        data: [12, 19, 3, 5, 2, 3],
        borderWidth: 1
      }]
    */
    datasets: [
    {
      label: 'Asks',
      data: asksData,
      borderColor: 'red',
      backgroundColor: 'rgba(255, 0, 0, 0.5)',
      pointRadius: 0,
      pointHoverRadius: 0,
      showLine: true
    },
    {
      label: 'Bids',
      data: bidsData,
      borderColor: 'green',
      backgroundColor: 'rgba(0, 255, 0, 0.5)',
      pointRadius: 0,
      pointHoverRadius: 0,
      showLine: true
    }
  ]

    },
    options: {
      /*
      scales: {
        y: {
          beginAtZero: true
        }
      }
      */
    }
  });
</script>
{% endblock %}
